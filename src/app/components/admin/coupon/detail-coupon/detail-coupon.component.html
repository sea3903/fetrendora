<div class="coupon-detail-page">
    <div class="page-header">
        <div class="header-content">
            <h2>{{ isUpdateMode ? 'Cập nhật Mã giảm giá' : 'Thêm mới Mã giảm giá' }}</h2>
        </div>
    </div>

    <div class="form-section">
        <form (ngSubmit)="saveCoupon()">
            <div class="form-group">
                <label for="code">Mã Coupon</label>
                <div class="input-group-text-only" style="position: relative;">
                    <i class="fas fa-ticket-alt"
                        style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #666;"></i>
                    <input type="text" id="code" required [(ngModel)]="coupon.code" name="code"
                        placeholder="VD: SUMMER2024, SALE50..." style="padding-left: 36px;">
                </div>
                <div class="helper-text">Mã này sẽ được khách hàng nhập khi thanh toán.</div>
            </div>

            <label class="custom-checkbox">
                <input type="checkbox" [(ngModel)]="coupon.active" name="active">
                <span>Kích hoạt mã giảm giá này</span>
            </label>

            <div class="conditions-section">
                <h4>Điều kiện áp dụng</h4>
                <p>Thêm các điều kiện để mã giảm giá có hiệu lực.</p>

                <div class="action-buttons mb-3">
                    <button type="button" class="btn-secondary mr-2" (click)="addCondition('amount')">
                        <i class="fas fa-dollar-sign"></i> Thêm đk: Đơn tối thiểu
                    </button>
                    <button type="button" class="btn-secondary" (click)="addCondition('date')">
                        <i class="fas fa-calendar-alt"></i> Thêm đk: Ngày áp dụng
                    </button>
                </div>

                <table class="conditions-table" *ngIf="coupon.conditions && coupon.conditions.length > 0">
                    <thead>
                        <tr>
                            <th style="width: 25%">Loại điều kiện</th>
                            <th style="width: 30%">Giá trị</th>
                            <th style="width: 25%">Giảm giá</th>
                            <th style="width: 10%; text-align: center;">Xóa</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let condition of coupon.conditions; let i = index">
                            <td>
                                <!-- Hiển thị nhân bản chọn loại điều kiện -->
                                <select class="form-control" [(ngModel)]="condition.attribute" [name]="'attr'+i">
                                    <option *ngFor="let opt of attributeOptions" [value]="opt.value">{{ opt.label }}
                                    </option>
                                </select>
                            </td>
                            <td>
                                <!-- INPUT DYNAMIC THEO ATTRIBUTE -->
                                <ng-container *ngIf="condition.attribute === 'minimum_amount'">
                                    <div class="input-group">
                                        <input type="number" class="form-control" [(ngModel)]="condition.value"
                                            [name]="'val'+i" placeholder="Nhập số tiền">
                                        <span class="suffix">VNĐ</span>
                                    </div>
                                    <!-- Hidden operator for amount -->
                                    <input type="hidden" [(ngModel)]="condition.operator" [name]="'op'+i" value=">">
                                </ng-container>

                                <ng-container *ngIf="condition.attribute === 'applicable_date'">
                                    <input type="date" class="form-control" [(ngModel)]="condition.value"
                                        [name]="'val'+i">
                                    <!-- Operator selector for date if needed, or default to BETWEEN/EQUAL -->
                                    <select class="form-control mt-1" [(ngModel)]="condition.operator" [name]="'op'+i"
                                        style="font-size: 0.8rem; padding: 4px;">
                                        <option value="BETWEEN">Trong ngày này</option>
                                        <option value="=">Chính xác ngày</option>
                                    </select>
                                </ng-container>

                                <!-- Fallback for other types -->
                                <ng-container
                                    *ngIf="condition.attribute !== 'minimum_amount' && condition.attribute !== 'applicable_date'">
                                    <input type="text" class="form-control" [(ngModel)]="condition.value"
                                        [name]="'val'+i">
                                </ng-container>
                            </td>
                            <td>
                                <div class="input-group">
                                    <input type="number" class="form-control" [(ngModel)]="condition.discount_amount"
                                        [name]="'disc'+i">
                                    <span class="suffix">%</span>
                                </div>
                            </td>
                            <td>
                                <button type="button" class="btn-danger-icon" (click)="removeCondition(i)">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <div class="empty-conditions" *ngIf="!coupon.conditions || coupon.conditions.length === 0">
                    Chưa có điều kiện nào. Hãy chọn loại điều kiện ở trên để thêm.
                </div>

            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary">
                    <i class="fas fa-save"></i> Lưu mã giảm giá
                </button>
                <button type="button" class="btn-secondary" routerLink="/admin/coupons">
                    Hủy bỏ
                </button>
            </div>
        </form>
    </div>
</div>